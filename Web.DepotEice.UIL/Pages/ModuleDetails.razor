@page "/modules/details/{Id:int}"
@using AutoMapper;
@using Web.DepotEice.BLL.IServices;
@using Web.DepotEice.BLL.Models;
@using Web.DepotEice.UIL.Models;

@inject ILogger<ModuleDetails> Logger;
@inject IMapper Mapper;
@inject IModuleService ModuleService;
@inject IUserService UserService;

<h3 class="text-center my-5"></h3>

@if (_module is null)
{
    <h4 class="text-center my-5">@_moduleErrorMessage</h4>
}
else
{
    <div class="container">
        <div class="row mb-3 border-bottom pb-3">
            <label class="form-label">Nom du module</label>
            <input class="form-control" value="@_module.Name" disabled />
        </div>

        <div class="row mb-3 border-bottom pb-3">
            <label class="form-label">Description</label>
            <textarea disabled style="height: 10rem">@_module.Description</textarea>
        </div>

        <div class="row mb-3 border-bottom pb-3">
            <label class="form-label">Professeur en charge</label>
            <input class="form-control" value="@_module.TeacherFullName" disabled />
        </div>

        <div class="d-flex flex-lg-row align-items-center">
            @if (_userIsAccepted.HasValue)
            {
                if (_userIsAccepted.Value)
                {
                    <button type="button" class="btn btn-outline-secondary" disabled>
                        Vous êtes déjà inscris à ce module
                    </button>
                }
                else
                {
                    <button type="button" class="btn btnbtn-outline-secondary" disabled>
                        Votre demande est en cours de traitement
                    </button>
                }
            }
            else
            {
                <button type="button" class="btn btn-outline-primary" @onclick="RequestAcceptance">
                    Demander à s'inscrire
                </button>
            }
            <NavLink href="#" class="mx-3">Voir l'horaire</NavLink>
        </div>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <span class="text-danger">@_errorMessage</span>
        }
    </div>
}

<Toasts Class="p-3" Messages="ToastMessages" Delay="5000" />

@code {
    [Parameter]
    public int Id { get; set; }

    /// <summary>
    /// List of toast messages
    /// </summary>
    public List<ToastMessage> ToastMessages { get; private set; } = new();

    private string _moduleErrorMessage = string.Empty;
    private string _errorMessage = string.Empty;
    private bool? _userIsAccepted = false;
    private ModuleDisplayModel _module = new();

    protected override async Task OnInitializedAsync()
    {
        var moduleResult = await ModuleService.GetModuleAsync(Id);

        if (!moduleResult.Success)
        {
            Logger.LogError($"The module request failed with status code \"{moduleResult.Code}\".\n{moduleResult.Message}");

            ShowMessage(
                ToastType.Danger,
                "Chargement du module",
                $"Le chargement du module a échoué.\n{moduleResult.Message}",
                false
            );

            return;
        }

        if (moduleResult.Data is null)
        {
            Logger.LogError($"The module request succeeded but the data is null.\n{moduleResult.Message}");

            ShowMessage(
                ToastType.Danger,
                "Chargement du module",
                $"Le chargement du module est réussi mais les données retournées sont null.\n{moduleResult.Data}",
                false
            );

            return;
        }

        ModuleModel moduleFromRepo = moduleResult.Data;

        _module = Mapper.Map<ModuleDisplayModel>(moduleFromRepo);

        try
        {
            var result = await UserService.GetUserAsync(moduleFromRepo.TeacherId);

            if (!result.Success)
            {
                Logger.LogError($"The request of the user has failed with status code \"{result.Code}\".\n{result.Message}");

                return;
            }

            if (result.Data is null)
            {
                Logger.LogError($"The requested user data is null.\n{result.Message}");

                return;
            }

            var teacher = result.Data;

            if (teacher is not null)
            {
                _module.TeacherFullName = $"{teacher.LastName.ToUpper()} {teacher.FirstName}";
            }
        }
        catch (Exception e)
        {
            Logger.LogError($"{DateTime.Now} - An exception was thrown when retrieving user and setting user full " +
                $"name.\n{e.Message}\n{e.StackTrace}");
        }

        // TODO : Check not if user is accepted but rather if there is a request and based on the value of the request
        // show pending request button if false and "You are already registered"
        _userIsAccepted = await ModuleService.UserIsAccepted(Id);
    }

    public async Task RequestAcceptance()
    {
        bool result = await ModuleService.RequestAcceptance(Id);

        if (!result)
        {
            Logger.LogError($"{DateTime.Now} - The request failed");
            _errorMessage = "La demande a échouée";
        }
        else
        {
            _errorMessage = "La demande est en cours";
        }

        _userIsAccepted = await ModuleService.UserIsAccepted(Id);
        StateHasChanged();
    }

    /// <summary>
    /// Add a new toast message to the list of toast messages
    /// </summary>
    /// <param name="toastType">The toast message type</param>
    /// <param name="title">The title of the toast message</param>
    /// <param name="message">The body message</param>
    /// <param name="autoHide">Decide if the toast should hide after a delay</param>
    private void ShowMessage(ToastType toastType, string title, string message, bool autoHide)
    {
        var toastMessage = new ToastMessage()
            {
                Type = toastType,
                Title = title,
                Message = message,
                AutoHide = autoHide,
                HelpText = $"{DateTime.Now}",
            };

        ToastMessages.Add(toastMessage);
    }
}
