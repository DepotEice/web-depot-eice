@using Web.DepotEice.BLL.IServices;
@using Web.DepotEice.BLL.Models;
@using Web.DepotEice.UIL.Managers;

@inject UserManager UserManager;
@inject ILogger<Authorize> Logger;
@inject IAuthService AuthService;

@if (IsAuthorized)
{
    @Authorized
}
else
{
    @Unauthorized
}

@code {
    [Parameter]
    public string? Role { get; set; }

    [Parameter]
    public RenderFragment? Authorized { get; set; }

    [Parameter]
    public RenderFragment? Unauthorized { get; set; }

    public bool IsAuthorized { get; private set; } = false;


    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation($"{DateTime.Now} - Requesting authorization for role \"{Role}\"");

        if (string.IsNullOrEmpty(Role))
        {
            ResultModel<bool> result = await AuthService.AuthorizeAsync();

            if (!result.Success)
            {
                Logger.LogError($"Getting authorization failed : \"{result.Message}\"");

                IsAuthorized = false;

                return;
            }

            IsAuthorized = result.Data;
        }
        else
        {
            IsAuthorized = await UserManager.IsInRoleAsync(Role);
        }

        StateHasChanged();
    }
}